<!DOCTYPE html5>
<html>
<head>
	<link rel="stylesheet" type="type/css" href="map.css">
	<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
</head>
<body>
	<table>
	<tr>
	<td>
	<div class="panel-container">
		<div class="left-panel">
			<ul>
			</ul>
		</div>
	</div>
	</td>
	<td>
	<canvas id="canvas" width="940" height="1024" style=""></canvas>
	</td>
	<!--
	<div class="right-panel">
		<ul>
			<li>RIGHT</li>
		</ul>
	</div>
	-->
	</tr>
</body>
</html>

<script>

function wrapText(ctx, text, x, y, maxWidth, textSize) {
	var words = text.split(' ');
	var line = '';

	for (var i = 0; i < words.length; i++) {
		var testLine = line + words[i] + ' ';
		var metrics = ctx.measureText(testLine);
		var testWidth = metrics.width;
		if (testWidth > maxWidth && i > 0) {
			ctx.fillText(line,x,y);
			line = words[i] + ' ';
			y += textSize;
		}
		else {
			line = testLine;
		}
	}
	ctx.fillText(line,x,y);
}

var canvas = $("#canvas")[0];
var bg = canvas.getContext("2d");
var ctx = canvas.getContext("2d");
var canvasWidth = 940;//$("#canvas").attr('width');
var canvasHeight = 1024;//$("#canvas").attr('height');
var debugOn = true;

var img = new Image();
var cursor = new Image();
img.src = 'maps/canvas.png';
cursor.src = 'misc/cursor.png'; 
img.onload = function() {
	bg.drawImage(img,0,0,canvasWidth,canvasHeight);
	drawTestGrid(ctx);
}

var Place = function(name,x,y,src,info) {
	this.name = name;
	this.x = x;
	this.y = y;
	this.src = img;
	this.info = info;
	this.img = new Image();
	this.img.src = src;
}

var currentLocation = new Place('null',0,0,'Campus_Buildings/alumni.jpg','null');

/* ------------------Test functions ----------------------*/
function drawTestGrid(context) {
	if (debugOn) {
		var offset = 50;
		context.strokeStyle = "black";
		for (var i = 0; i < canvasWidth; i+=offset) {
			context.beginPath();
			context.moveTo(i,0);
			context.lineTo(i,canvasHeight);
			context.stroke();
		}
		for (var i = 0; i < canvasHeight; i+=offset) {
			context.beginPath();
			context.moveTo(0,i);
			context.lineTo(canvasWidth,i);
			context.stroke();
		}
	}
}

function displayHoverRange(context) {
	if (debugOn) {
		context.beginPath();
		context.lineWidth="2";
		context.strokeStyle = "red";
		context.rect(currentLocation.x-12,currentLocation.y-25,50,50);
		context.stroke();
	}
}

/* -------------------------------------------------------*/
var locations = Array();

// Not difficult to do using jinja, but for the purposes of this demo, 
// we will fetch database information from a txt file.
$.get('database/canvas.txt', function(data) {
	var tuples = data.split('\n');
	for (var i = 0; i < tuples.length - 1; i++) {
		var param = tuples[i].split('|');
		locations.push(new Place(param[0],param[1],param[2],('Campus_Buildings/'+param[3]),param[4]));

			$('.left-panel ul').append('<li onclick="drawLocation('+i+')">'+locations[i].name+'</li>');
	}
	//console.log(locations);	
});

function clearScreen(context) {
	context.fillStyle = "#FFFFFF";
	context.fillRect(0,0,canvasWidth, canvasHeight);
}

function drawLocation(index) {
	console.log('Drawing Location for ' + locations[index].name);
	currentLocation = locations[index];
	clearScreen(ctx);
	bg.drawImage(img,0,0,canvasWidth,canvasHeight);
	drawTestGrid(ctx);
	ctx.drawImage(cursor,currentLocation.x - 12,currentLocation.y - 25,50,50);
	displayInformation(ctx);
	ctx.fillStyle = "#FF0000";
}

function displayInformation(context) {
	ctx.fillStyle = "#00FF00";
	ctx.fillRect(600,0,340,300);
	ctx.drawImage(currentLocation.img,650,25,250,100);
	ctx.fillStyle = "#000000";
	//ctx.fillText(currentLocation.info,650,150);
	wrapText(context, currentLocation.info, 650, 150, 250, 20);
}

$('.left-panel ul li').click(function(e) {
	drawLocation(ctx);
	displayInformation(ctx);
});
</script>
